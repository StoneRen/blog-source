# sails中的小技巧: 用户积分变动后更新等级


主要是`toJSON`

用户的等级是由积分确定的.但是积分的来源有多个,比如关注,点赞.

一开始想到的方案是:
1. 用户关注后 触发 积分改变 积分改变 触发 等级改变
2. 点赞之后 触发 积分改变 积分改变 触发 等级改变

问题是什么呢?

如果用户没有人点击关注, 我直接修改数据库后,用户的积分变化了,但是等级没有触发的操作,所以等级不会改变.(当然了,后台管理员读积分的操作(初始化,增加,减少)也会触发操作)

还有一个麻烦的就是 对用户信息的请求时候,我也得判断是否积分和等级匹配. 比如积分1000积分了,已经触发等级3了,但是之前的异步操作可能会有问题,积分改变了,但是等级没变.

我要是针对用户的操作都修改的话,太太太太麻烦了.单个用户信息请求,用户列表,登录用户等等,太多地方都需要一个一个去检查了.

现在简单了,只需要修改一个地方就可以了,这样在返回给前端的数据都不会发生尴尬了.

看下面代码,做了以下操作:
1. 删除敏感信息和不需要的信息
2. id 手机号和level 都经过自定义处理

```js
toJSON() {
  var obj = this.toObject();
  delete obj["password"];
  delete obj["createdAt"];
  delete obj["openid"];
  if(obj.phone){
    obj.phone=obj.phone.substr(0,3)+'****'+obj.phone.substr(7,10);
  }
  obj.level=LevelService.get(obj.point);
  obj.id = Ids.hash(obj.id);
  return obj;
}
```