---
title: 技术事故引发的警告
date: 2017-09-15 11:50:34
tags: [sails,pm2,pm2-logrotate]
---

一次技术事故引发的警告.

昨晚更新项目到测试环境了.有一个定时任务,每一个分钟去同步第三方数据库,写入本地数据库.

结果今早起来一看,`嚯~~~~`,日志文件都写了快10个G了.

![log](https://ss.jiasucloud.com/blog/image/WX20170915-102632.png-s)

幸好之前`pm2`用了`pm2-logrotate`插件.对这些日志文件进行归纳整理.

否则单文件过大也比较困扰.
<img src="https://ss.jiasucloud.com/blog/image/WechatIMG194.jpeg-s" alt="困扰" width="50%" />

不过这里面暴露了以下几个问题:

<!--more-->

1. 监控规则设置有问题.因为cpu一直也就30%-40%,内存也一直没超过50% 所以一直没有报警
2. 像这种定时任务和一些和第三方对接的事情一定要放在测试环境中测试完全. 我在本地测试没问题.测试环境中测了3个多小时也没问题.测试环境下午5点部署上去的.今早凌晨开始大量写错误日志了
3. 在开发中已经设置了重试的最大次数.结果还是低估了机器不知道累的情况.重试次数设置过大,导致他不知疲倦的在错误里面老是重复.

最终查到的原因如下:

1. 第三方返回的数据中有一个字段`trade_money`,官方说`traded_money Price 344 成交订单总额。单位：元`
2. 我把这个类型设置为了`float`
3. 结果第三方返回的数据包含三种形式 `298.39`,`0`和`""`

是的,你没看错,官方返回的第三种方式是一个空字符串.结果就是这个空字符串在存数据库前,`sails`的`orm`自动认为他不是`float`,在前期验证就报错了.

所以解决办法也好解决:

```js
u.trade_money = parseFloat(user.trade_money)?parseFloat(user.trade_money):0;
u.save()
```
